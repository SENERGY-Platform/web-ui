<!--
  ~ Copyright 2024 InfAI (CC SES)
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->
<mat-expansion-panel *ngIf="data !== undefined" class="reporting-object">
    <mat-expansion-panel-header>
        <mat-panel-title> {{ name }} </mat-panel-title>
        <mat-panel-description *ngIf="data.valueType!=='object' && inputType==='value' && data.value !== undefined">
            {{data.valueType }} - {{inputType}}:{{data.value}} </mat-panel-description>
        <mat-panel-description *ngIf="data.valueType!=='object' && inputType==='value' && data.value === undefined">
            {{data.valueType }} - {{inputType}}</mat-panel-description>
        <mat-panel-description *ngIf="data.valueType==='object'"> {{data.valueType }}</mat-panel-description>
        <mat-panel-description *ngIf="inputType==='query'"> {{data.valueType }} - {{inputType}} -
            {{queryDevice.display_name || queryDevice?.display_name}}/{{queryService.name}}/{{data.query!.columns[0].name}} </mat-panel-description>
    </mat-expansion-panel-header>
    <div fxLayout="column">
        <div fxLayout="row">
            <mat-radio-group
                *ngIf="data.valueType === 'string' || data.valueType === 'float64' || data.valueType === 'array'"
                [(ngModel)]="inputType" (ngModelChange)="changeInputType()" aria-label="Select an option">
                <mat-radio-button value="value">Value</mat-radio-button>
                <mat-radio-button value="query">Query</mat-radio-button>
            </mat-radio-group>
            <button *ngIf="inputType === 'query' && data.query !== undefined" mat-icon-button matTooltip="Preview Query"
                (click)="previewQuery()">
                <mat-icon>preview</mat-icon>
            </button>
        </div>
        <div *ngIf="inputType === 'query' && data.query !== undefined" fxLayout="column">
            <mat-form-field fxFlex color="accent" appearance="outline">
                <mat-label>Device</mat-label>
                <senergy-select-search [options]="allDevices" [getOptionViewValue]="getDeviceName"
                    ngDefaultControl (ngModelChange)="queryDeviceChanged($event).subscribe()" [(ngModel)]="queryDevice"
                    [multiple]="false">
                </senergy-select-search>
                <mat-error senergyError label="Device"></mat-error>
            </mat-form-field>
            <mat-form-field fxFlex color="accent" appearance="outline">
                <mat-label>Service</mat-label>
                <senergy-select-search (ngModelChange)="queryServiceChanged($event)"
                    [(ngModel)]="queryService" [options]="queryDeviceType.services" useOptionViewProperty="name">
                </senergy-select-search>
                <mat-error senergyError label="Service"></mat-error>
            </mat-form-field>
            <mat-form-field fxFill color="accent" appearance="outline" *ngIf="data.query.columns !== undefined">
                <mat-label>Path</mat-label>
                <input matInput [(ngModel)]="data.query!.columns[0].name" placeholder="Choose or write yourself"
                    [matAutocomplete]="auto" />
                <mat-autocomplete #auto="matAutocomplete">
                    <mat-option *ngFor="let path of queryServicePaths | keyvalue"
                        [value]="path.value">{{path.value}}</mat-option>
                </mat-autocomplete>
                <mat-error senergyError label="Path"></mat-error>
            </mat-form-field>
            <mat-form-field fxFill color="accent" appearance="outline" *ngIf="data.query.columns !== undefined">
                <mat-label>Field Group Type</mat-label>
                <mat-select [(ngModel)]="data.query!.columns[0].groupType">
                    <mat-option *ngFor="let type of fieldGroupTypes" [value]="type">{{type}}</mat-option>
                </mat-select>
                <mat-error senergyError label="Field Group Type"></mat-error>
            </mat-form-field>
            <div role="group" class="form-grouping">
                <mat-form-field fxFlex color="accent" appearance="outline">
                    <mat-label>Grouping Time</mat-label>
                    <input matInput [(ngModel)]="groupingTime.number" (ngModelChange)="setGroupingTime()">
                    <mat-error senergyError label="Grouping Time"></mat-error>
                </mat-form-field>
                <mat-form-field fxFlex color="accent" appearance="outline">
                    <mat-label>Grouping Time Unit</mat-label>
                    <mat-select [(ngModel)]="groupingTime.unit" (ngModelChange)="setGroupingTime()">
                        <mat-option *ngFor="let units of timeUnits" [value]="units.unit">{{units.desc}}</mat-option>
                    </mat-select>
                    <mat-error senergyError label="Grouping Time Unit"></mat-error>
                </mat-form-field>
            </div>
            <div role="group" class="form-grouping">
                <mat-form-field fxFlex color="accent" appearance="outline">
                    <mat-label>Time Frame</mat-label>
                    <input matInput [(ngModel)]="timeframe.number" (ngModelChange)="setTimeframe()">
                    <mat-error senergyError label="Time Frame"></mat-error>
                </mat-form-field>
                <mat-form-field fxFlex color="accent" appearance="outline">
                    <mat-label>Time Frame Unit</mat-label>
                    <mat-select [(ngModel)]="timeframe.unit" (ngModelChange)="setTimeframe()">
                        <mat-option *ngFor="let units of timeUnits" [value]="units.unit">{{units.desc}}</mat-option>
                    </mat-select>
                    <mat-error senergyError label="Time Frame Unit"></mat-error>
                </mat-form-field>
            </div>
        </div>

        <div *ngIf="inputType === 'value'" fxLayout="column">
            <div *ngIf="data.valueType === 'string'">
                <mat-form-field fxFlex color="accent" appearance="outline">
                    <mat-label>{{ name }} String</mat-label>
                    <input matInput [(ngModel)]="data.value">
                    <mat-error senergyError label="{{ name }} String"></mat-error>
                </mat-form-field>
            </div>
            <div *ngIf="data.valueType === 'float64'">
                <mat-form-field fxFlex color="accent" appearance="outline">
                    <mat-label>{{ name }} Float64</mat-label>
                    <input matInput [(ngModel)]="data.value">
                    <mat-error senergyError label="{{ name }} Float64"></mat-error>
                </mat-form-field>
            </div>
            <div *ngIf="data.valueType === 'object' && data.fields !== undefined">

                <senergy-reporting-object *ngFor="let element of data.fields | keyvalue" [requestObject]="requestObject"
                    [name]="element.key" [data]="element.value" [allDevices]="allDevices">
                </senergy-reporting-object>
            </div>
            <div *ngIf="data.valueType === 'array' && data.children !== undefined">
                <senergy-reporting-object *ngFor="let element of data.children | keyvalue"
                    [requestObject]="requestObject" [name]="element.key" [data]="element.value"
                    [allDevices]="allDevices">
                </senergy-reporting-object>
            </div>
        </div>
    </div>
</mat-expansion-panel>