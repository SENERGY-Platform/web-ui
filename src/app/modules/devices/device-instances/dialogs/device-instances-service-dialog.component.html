<!--
  ~ Copyright 2020 InfAI (CC SES)
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<div mat-dialog-title>
    <span fxFlex>Data</span>
    <button mat-icon-button color="accent" (click)="refresh()">
        <mat-icon>refresh</mat-icon>
    </button>
</div>

<mat-dialog-content>
    <div id="id-container">
        <mat-form-field class="full-width" color="accent">
            <mat-label>ID</mat-label>
            <input matInput placeholder="ID" disabled value="{{device.id}}">
        </mat-form-field>
        <mat-form-field class="full-width" color="accent">
            <mat-label>Short ID</mat-label>
            <input matInput placeholder="ShortID" disabled value="{{getShortId(device.id)}}">
        </mat-form-field>
        <mat-form-field class="full-width" color="accent">
            <mat-label>Devicetype ID</mat-label>
            <input matInput placeholder="Devicetype ID" disabled value="{{device.device_type.id}}">
        </mat-form-field>
        <mat-form-field class="full-width" color="accent">
            <mat-label>Devicetype Name</mat-label>
            <input matInput placeholder="Devicetype Name" disabled value="{{device.device_type.name}}">
        </mat-form-field>
        <mat-form-field class="full-width" color="accent">
            <mat-label>Origin Name</mat-label>
            <input matInput placeholder="Origin Name" [(ngModel)]="device.name" disabled
                [ngModelOptions]="{standalone: true}">
        </mat-form-field>
        <mat-form-field class="full-width" color="accent">
            <mat-label>Local ID</mat-label>
            <input matInput placeholder="Local ID" [(ngModel)]="device.local_id" disabled>
        </mat-form-field>
    </div>

    <mat-accordion>
        <mat-expansion-panel *ngFor="let service of services; let i = index" [expanded]="services.length === 1">
            <mat-expansion-panel-header>
                <mat-panel-title fxFlex>{{service.name}}</mat-panel-title>
                <mat-panel-description>
                    {{service.description}}
                    <span
                        *ngIf="lastValueArray[i] !== undefined && lastValueArray[i].length > 0">{{lastValueArray[i][0].response.time |  date:'dd.MM.yyyy - HH:mm:ss'}}</span>
                </mat-panel-description>
            </mat-expansion-panel-header>

            <ng-template matExpansionPanelContent>
                <div *ngIf="errorOccured === false && lastValueArray[i] !== undefined">
                    <table mat-table *ngIf="lastValueArray[i].length > 0" [dataSource]="lastValueArray[i]">
                        <ng-container matColumnDef="field">
                            <th mat-header-cell *matHeaderCellDef>Field</th>
                            <td mat-cell *matCellDef="let element"> {{element.request.columnName}} </td>
                        </ng-container>

                        <ng-container matColumnDef="value">
                            <th mat-header-cell *matHeaderCellDef>Value</th>
                            <td mat-cell *matCellDef="let element">
                                {{element.response.value !== null ? element.response.value : 'N/A'}} </td>
                        </ng-container>

                        <ng-container matColumnDef="description">
                            <th mat-header-cell *matHeaderCellDef>Description</th>
                            <td mat-cell *matCellDef="let element">
                                {{element.description !== undefined ? (element.description) : 'N/A'}} </td>
                        </ng-container>

                        <tr mat-header-row *matHeaderRowDef="['field', 'value', 'description']"></tr>
                        <tr mat-row *matRowDef="let row; columns: ['field', 'value', 'description'];"></tr>
                    </table>
                    <span *ngIf="lastValueArray[i].length === 0">Service does not provide data</span>
                    <div *ngIf="lastValueArray[i].length > 0">
                        <mat-expansion-panel>
                            <mat-expansion-panel-header>
                                <mat-panel-title fxFlex>Download Data</mat-panel-title>
                            </mat-expansion-panel-header>
                            <ng-template matExpansionPanelContent>
                                <div fxLayout="column">
                                    <mat-form-field fxFlex color="accent" appearance="fill">
                                        <mat-label>Data Format</mat-label>
                                        <senergy-select-search [options]="filterAvailability(i)"
                                            [getOptionViewValue]="formatAvailability"
                                            [getOptionValue]="valueAvailability" [formControl]="availabilityControl"
                                            [compareWith]="compareAvailabilityValue" placeholder="Device">
                                        </senergy-select-search>
                                    </mat-form-field>
                                    <mat-form-field appearance="fill" fxFlex color="accent" (click)="picker.open()">
                                        <mat-label>Enter a date range</mat-label>
                                        <mat-date-range-input [formGroup]="timeControl" [rangePicker]="picker"
                                            [min]="getMin(i)" [max]="getMax(i)">
                                            <input matStartDate formControlName="from" placeholder="Start date">
                                            <input matEndDate formControlName="to" placeholder="End date">
                                        </mat-date-range-input>
                                        <mat-datepicker-toggle matPrefix [for]="picker" disabled="false">
                                        </mat-datepicker-toggle>
                                        <mat-date-range-picker #picker disabled="false"></mat-date-range-picker>

                                        <button matSuffix mat-icon-button (click)="download($event, i)">
                                            <mat-icon>download</mat-icon>
                                        </button>
                                        <mat-error *ngIf="timeControl.controls.from.hasError('matStartDateInvalid')">
                                            Invalid
                                            start
                                            date
                                        </mat-error>
                                        <mat-error *ngIf="timeControl.controls.to.hasError('matEndDateInvalid')">Invalid
                                            end
                                            date
                                        </mat-error>
                                    </mat-form-field>
                                </div>
                            </ng-template>
                        </mat-expansion-panel>
                    </div>
                </div>

            </ng-template>

            <div *ngIf="errorOccured === true">
                {{errorMessage}}
            </div>
        </mat-expansion-panel>
    </mat-accordion>
</mat-dialog-content>

<mat-dialog-actions fxLayoutAlign="end center">
    <button mat-raised-button color="accent" (click)="close()">Close</button>
</mat-dialog-actions>