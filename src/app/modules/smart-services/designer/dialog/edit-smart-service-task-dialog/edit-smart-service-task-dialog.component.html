<!--
  ~ Copyright 2020 InfAI (CC SES)
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->


<mat-dialog-content class="edit-smart-service-task-dialog">
  <mat-tab-group  dynamicHeight="true" [(selectedIndex)]="activeIndex">
    <mat-tab label="Process">
      <div class="smart-service-task-tab">
        <div>
          <mat-form-field  color="accent" class="full-width">
            <input matInput placeholder="Task-Name" [(ngModel)]="result.name">
          </mat-form-field>
        </div>
        <div>
          <mat-form-field  color="accent" class="full-width">
            <mat-label>Process-Model</mat-label>
            <mat-select [(ngModel)]="processProcessModelId">
              <mat-option *ngFor="let model of processModels" [value]="model.id">
                {{model.name}}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>
        <div>
          <mat-form-field  color="accent" class="full-width">
            <input matInput placeholder="Deployment-Name" [(ngModel)]="processProcessName" required>
          </mat-form-field>
        </div>

        <div>
          <mat-card>
            <mat-accordion>
            <mat-expansion-panel *ngFor="let taskId of processTaskIds">
              <mat-expansion-panel-header>
                <mat-panel-title>
                  {{taskId}}
                </mat-panel-title>
              </mat-expansion-panel-header>
              <div>
                <ng-container *ngFor="let input of result.inputs">
                  <div *ngIf="processTaskMatches(input, taskId, 'selection')">
                    <mat-form-field  color="accent" class="full-width">
                      <mat-label>IoT-Selection</mat-label>
                      <mat-select [(ngModel)]="input.value">
                        <mat-option *ngFor="let variable of availableProcessVariables.get('iot_form_fields') || []" [value]="'${'+variable.name+'}'">
                          {{variable.label || variable.name}}
                        </mat-option>
                      </mat-select>
                    </mat-form-field>
                    <mat-form-field  color="accent" class="full-width">
                      <input matInput placeholder="IoT-Selection Value" [(ngModel)]="input.value" required>
                    </mat-form-field>
                  </div>
                  <div *ngIf="processTaskMatches(input, taskId, 'time')">
                    <mat-form-field  color="accent" class="full-width">
                      <input matInput placeholder="Time-Event" [(ngModel)]="input.value" required>
                    </mat-form-field>
                  </div>
                  <div *ngIf="processTaskMatches(input, taskId, 'event.flow_id')">
                    <mat-form-field  color="accent" class="full-width">
                      <mat-label>Event-Flow</mat-label>
                      <mat-select [(ngModel)]="input.value">
                        <mat-option *ngFor="let flow of flows" [value]="flow._id">
                          {{flow.name}}
                        </mat-option>
                      </mat-select>
                    </mat-form-field>
                  </div>
                  <div *ngIf="processTaskMatches(input, taskId, 'event.value')">
                    <mat-form-field  color="accent" class="full-width">
                      <input matInput placeholder="Event-Value" [(ngModel)]="input.value">
                    </mat-form-field>
                  </div>
                  <ng-container *ngFor="let parameter of getProcessTaskParameter(taskId)">
                    <div *ngIf="processTaskMatches(input, taskId, 'parameter.'+parameter)">
                      <mat-form-field  color="accent" class="full-width">
                        <input matInput placeholder="{{parameter}}" [(ngModel)]="input.value">
                      </mat-form-field>
                    </div>
                  </ng-container>
                </ng-container>
              </div>
            </mat-expansion-panel>
          </mat-accordion>
          </mat-card>
        </div>
      </div>
    </mat-tab>
    <mat-tab label="Analytics">
      <div class="smart-service-task-tab">
        <div class="smart-service-task-tab">
          <div>
            <mat-form-field  color="accent" class="full-width">
              <input matInput placeholder="Task-Name" [(ngModel)]="result.name">
            </mat-form-field>
          </div>
          <div>
            <mat-form-field class="form-field full-width" color="accent">
              <senergy-select-search placeholder="Flow"
                                     [(ngModel)]="analyticsFlowId"
                                     [options]="flows || []"
                                     useOptionViewProperty="name"
                                     useOptionValueProperty="_id">
              </senergy-select-search>
            </mat-form-field>
          </div>
          <div>
            <mat-form-field  color="accent" class="full-width">
              <input matInput placeholder="Pipeline-Name" [(ngModel)]="analyticsPipelineName" required>
            </mat-form-field>
          </div>
          <div>
            <mat-form-field  color="accent" class="full-width">
              <input matInput placeholder="Pipeline-Description" [(ngModel)]="analyticsPipelineDesc">
            </mat-form-field>
          </div>
          <div>
            <mat-form-field  color="accent" class="full-width">
              <input matInput placeholder="Pipeline Window-Time" [(ngModel)]="analyticsWindowTime" required>
            </mat-form-field>
          </div>

          <div *ngIf="flowSvg"
               class="image-svg-wrapper"
               [innerHtml]="getAnalyticsFlowImage(flowSvg, currentFlowInputId)"
                (click)="analyticsSvgSelectOperator($event)">
          </div>

          <div>
            <mat-card>
              <mat-accordion>
                <mat-expansion-panel
                        *ngFor="let flowInput of currentParsedFlows"
                        [expanded]="currentFlowInputId == flowInput.id"
                        (opened)="currentFlowInputId = flowInput.id">
                  <mat-expansion-panel-header>
                    <mat-panel-title>
                      {{flowInput.name}}
                    </mat-panel-title>
                  </mat-expansion-panel-header>
                  <div>
                    <div *ngFor="let port of flowInput.inPorts">
                      <mat-divider [inset]="true"></mat-divider>
                      <h4 class="mat-h4">{{port}}</h4>
                      <ng-container *ngFor="let input of result.inputs">
                        <div *ngIf="analyticsInputMatchesIotSelection(input, flowInput.id, port)">
                          <mat-form-field  color="accent" class="full-width">
                            <mat-label>IoT-Selection</mat-label>
                            <mat-select [(ngModel)]="input.value">
                              <mat-option *ngFor="let variable of availableProcessVariables.get('iot_form_fields') || []" [value]="'${'+variable.name+'}'">
                                {{variable.label || variable.name}}
                              </mat-option>
                              <mat-option *ngFor="let variable of availableProcessVariables.get('import_selection') || []" [value]="variable.name">
                                {{variable.label || variable.name}}
                              </mat-option>
                            </mat-select>
                          </mat-form-field>
                          <mat-form-field  color="accent" class="full-width">
                            <input matInput placeholder="IoT-Selection Value" [(ngModel)]="input.value" required>
                          </mat-form-field>
                        </div>
                        <div *ngIf="analyticsInputMatchesIotCriteria(input, flowInput.id, port)">
                          <mat-form-field  color="accent" class="full-width">
                            <input matInput placeholder="IoT-Criteria" [(ngModel)]="input.value" required>
                          </mat-form-field>
                        </div>
                      </ng-container>
                    </div>
                    <mat-divider [inset]="true"></mat-divider>
                    <h4 class="mat-h4">Configurations</h4>
                    <div>
                      <ng-container *ngFor="let input of result.inputs">
                        <mat-checkbox
                                class="checkbox-margin"
                                *ngIf="analyticsInputMatchesPersistDataField(input, flowInput.id)"
                                [(ngModel)]="input.value"
                                stringCheckboxValue
                                trueValue="true"
                                falseValue="false">
                          Persist Data
                        </mat-checkbox>
                      </ng-container>
                    </div>
                    <div *ngFor="let config of flowInput.config">
                      <ng-container *ngFor="let input of result.inputs">
                        <div *ngIf="analyticsInputMatchesIotConfig(input, flowInput.id, config.name)">
                          <mat-form-field  color="accent" class="full-width">
                            <input matInput placeholder="{{config.name}}" [(ngModel)]="input.value">
                          </mat-form-field>
                        </div>
                      </ng-container>
                    </div>
                  </div>
                </mat-expansion-panel>
              </mat-accordion>
            </mat-card>
          </div>
        </div>
      </div>
    </mat-tab>
    <mat-tab label="Export">
      <div class="smart-service-task-tab">
        <div>
          <mat-form-field  color="accent" class="full-width">
            <input matInput placeholder="Task-Name" [(ngModel)]="result.name">
          </mat-form-field>
        </div>
        <div>
          <mat-form-field  color="accent" class="full-width">
            <input matInput placeholder="Name" [(ngModel)]="exportRequest.Name" type="text" required>
          </mat-form-field>
        </div>
        <div>
          <mat-form-field  color="accent" class="full-width">
            <input matInput placeholder="Description" [(ngModel)]="exportRequest.Description" type="text">
          </mat-form-field>
        </div>
        <div>
          <mat-form-field  color="accent" class="full-width">
            <mat-label>FilterType</mat-label>
            <mat-select [(ngModel)]="exportRequest.FilterType" required>
              <mat-option value="deviceId">deviceId</mat-option>
              <mat-option value="operatorId">operatorId</mat-option>
              <mat-option value="import_id">import_id</mat-option>
            </mat-select>
          </mat-form-field>
        </div>
        <div>
          <mat-form-field  color="accent" class="full-width">
            <input matInput placeholder="Filter" [(ngModel)]="exportRequest.Filter" type="text" #filterInput required>
            <button mat-icon-button matSuffix [matMenuTriggerFor]="menu">
              <mat-icon>data_object</mat-icon>
            </button>
            <mat-menu #menu="matMenu">
              <ng-container *ngIf="exportRequest.FilterType == 'operatorId'">
                <button mat-menu-item *ngFor="let param of availableProcessVariables.get('flow_selection')" (click)="exportRequest.Filter = param.name" [matTooltip]="param.name">
                  {{param.label || param.name}}
                </button>
              </ng-container>
              <ng-container *ngIf="exportRequest.FilterType == 'import_id'">
                <button mat-menu-item *ngFor="let param of availableProcessVariables.get('import')" (click)="exportRequest.Filter = param.name" [matTooltip]="param.name">
                  {{param.label || param.name}}
                </button>
              </ng-container>
              <button mat-menu-item *ngFor="let param of availableProcessVariables.get('uncategorized')" (click)="exportRequest.Filter = param.name" [matTooltip]="param.name">
                {{param.label || param.name}}
              </button>
            </mat-menu>
          </mat-form-field>
        </div>
        <div>
          <mat-form-field  color="accent" class="full-width">
            <input matInput placeholder="EntityName" [(ngModel)]="exportRequest.EntityName" type="text" required>
          </mat-form-field>
        </div>
        <div>
          <mat-form-field  color="accent" class="full-width">
            <input matInput placeholder="Topic" [(ngModel)]="exportRequest.Topic" type="text" required>
          </mat-form-field>
        </div>
        <div>
          <mat-form-field  color="accent" class="full-width">
            <input matInput placeholder="ExportDatabaseID" [(ngModel)]="exportRequest.ExportDatabaseID" type="text" required>
          </mat-form-field>
        </div>
        <div>
          <mat-form-field  color="accent" class="full-width">
            <input matInput placeholder="TimePath" [(ngModel)]="exportRequest.TimePath" type="text" required>
          </mat-form-field>
        </div>
        <div>
          <mat-form-field  color="accent" class="full-width">
            <input matInput placeholder="TimestampFormat" [(ngModel)]="exportRequest.TimestampFormat" type="text">
          </mat-form-field>
        </div>
        <div>
          <mat-form-field  color="accent" class="full-width">
            <input matInput placeholder="TimePrecision" [(ngModel)]="exportRequest.TimePrecision" type="text">
          </mat-form-field>
        </div>
        <div>
          <mat-form-field  color="accent" class="full-width">
            <input matInput placeholder="ServiceName" [(ngModel)]="exportRequest.ServiceName" type="text" required>
          </mat-form-field>
        </div>
        <div>
          <mat-form-field  color="accent" class="full-width">
            <mat-label>Offset</mat-label>
            <mat-select [(ngModel)]="exportRequest.Offset" required>
              <mat-option value="largest">largest</mat-option>
              <mat-option value="smallest">smallest</mat-option>
            </mat-select>
          </mat-form-field>
        </div>
        <div>
          <mat-checkbox class="checkbox-margin" [(ngModel)]="exportRequest.generated">Generated</mat-checkbox>
        </div>
        <mat-accordion>
          <mat-expansion-panel *ngFor="let value of exportRequest.Values; let i = index">
            <mat-expansion-panel-header>
              <mat-panel-title>
                {{value.Name}}
              </mat-panel-title>
            </mat-expansion-panel-header>
            <div>
              <div>
                <mat-form-field  color="accent" class="full-width">
                  <input matInput placeholder="Name" [(ngModel)]="value.Name" type="text" required>
                </mat-form-field>
              </div>
              <div>
                <mat-form-field  color="accent" class="full-width">
                  <input matInput placeholder="Path" [(ngModel)]="value.Path" type="text" required>
                </mat-form-field>
              </div>
              <div>
                <mat-form-field  color="accent" class="full-width">
                  <mat-label>Type</mat-label>
                  <mat-select [(ngModel)]="value.Type" required>
                    <mat-option value="string">string</mat-option>
                    <mat-option value="float">float</mat-option>
                    <mat-option value="bool">bool</mat-option>
                    <mat-option value="string_json">string_json</mat-option>
                  </mat-select>
                </mat-form-field>
              </div>
              <div>
                <mat-checkbox class="checkbox-margin" [(ngModel)]="value.Tag">Tag</mat-checkbox>
              </div>
              <div>
                <button mat-raised-button color="accent" (click)="removeExportValue(i)">Remove Value</button>
              </div>
            </div>
          </mat-expansion-panel>
        </mat-accordion>
        <div>
          <button mat-raised-button color="accent" (click)="addExportValue()">Add Value</button>
        </div>
      </div>
    </mat-tab>
    <mat-tab label="Import">
      <div class="smart-service-task-tab">
        <div>
          <mat-form-field  color="accent" class="full-width">
            <input matInput placeholder="Task-Name" [(ngModel)]="result.name">
          </mat-form-field>
        </div>
        <div>
          <mat-form-field  color="accent" class="full-width">
            <input matInput placeholder="Name" [(ngModel)]="importRequest.name" type="text">
          </mat-form-field>
        </div>
        <div>
          <mat-form-field  color="accent" class="full-width">
            <mat-label>Import-Type</mat-label>
            <mat-select [(ngModel)]="importTypeId">
              <mat-option *ngFor="let importType of importTypes" [value]="importType.id">
                {{importType.name}}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>
      </div>
      <div>
        <mat-checkbox class="checkbox-margin" [(ngModel)]="importRequest.restart">Generated</mat-checkbox>
      </div>
      <div>
        <mat-checkbox class="checkbox-margin" [(ngModel)]="importRequest.generated">Restart</mat-checkbox>
      </div>
      <div *ngFor="let config of importRequest.configs" class="input-with-overwrite">
        <mat-form-field  color="accent" class="input-with-overwrite-value" *ngIf="isTextImportConfig(config)">
          <input matInput placeholder="{{config.name}}" [(ngModel)]="config.value" type="text">
        </mat-form-field>
        <mat-form-field  color="accent" class="input-with-overwrite-value" *ngIf="isNumberImportConfig(config)">
          <input matInput placeholder="{{config.name}}" [(ngModel)]="config.value" type="number">
        </mat-form-field>
        <mat-checkbox class="checkbox-margin" *ngIf="isBooleanImportConfig(config)" [(ngModel)]="importRequest.restart">{{config.name}}</mat-checkbox>
        <mat-form-field  color="accent" class="input-with-overwrite-value" *ngIf="isUnknownImportConfig(config)">
          <input matInput placeholder="{{config.name}}" [(ngModel)]="config.value" type="text" isValidJson>
        </mat-form-field>
        <ng-container *ngFor="let overwrite of importOverwrites">
          <mat-form-field *ngIf="overwrite.config_name == config.name" color="accent" class="input-with-overwrite-overwrite">
            <input matInput placeholder="{{config.name}} overwrite with placeholder evaluated as json" [(ngModel)]="overwrite.json_value" type="text" #overwriterJsonInput>
            <button mat-icon-button matSuffix [matMenuTriggerFor]="menu">
              <mat-icon>data_object</mat-icon>
            </button>
            <mat-menu #menu="matMenu">
              <button mat-menu-item *ngFor="let param of availableProcessVariables.get('iot_form_fields')" (click)="overwrite.json_value = appendParam(overwrite.json_value, param, overwriterJsonInput)" [matTooltip]="param.name">
                IoT: {{param.label || param.name}}
              </button>
              <button mat-menu-item *ngFor="let param of availableProcessVariables.get('value_form_fields')" (click)="overwrite.json_value = appendParam(overwrite.json_value, param, overwriterJsonInput)" [matTooltip]="param.name">
                Value: {{param.label || param.name}}
              </button>
              <button mat-menu-item *ngFor="let param of availableProcessVariables.get('process_deployment')" (click)="overwrite.json_value = appendParam(overwrite.json_value, param, overwriterJsonInput)" [matTooltip]="param.name">
                {{param.label || param.name}}
              </button>
              <button mat-menu-item *ngFor="let param of availableProcessVariables.get('analytics')" (click)="overwrite.json_value = appendParam(overwrite.json_value, param, overwriterJsonInput)" [matTooltip]="param.name">
                {{param.label || param.name}}
              </button>
              <button mat-menu-item *ngFor="let param of availableProcessVariables.get('export')" (click)="overwrite.json_value = appendParam(overwrite.json_value, param, overwriterJsonInput)" [matTooltip]="param.name">
                {{param.label || param.name}}
              </button>
              <button mat-menu-item *ngFor="let param of availableProcessVariables.get('import')" (click)="overwrite.json_value = appendParam(overwrite.json_value, param, overwriterJsonInput)" [matTooltip]="param.name">
                {{param.label || param.name}}
              </button>
              <button mat-menu-item *ngFor="let param of availableProcessVariables.get('uncategorized')" (click)="overwrite.json_value = appendParam(overwrite.json_value, param, overwriterJsonInput)" [matTooltip]="param.name">
                {{param.label || param.name}}
              </button>
            </mat-menu>
          </mat-form-field>
        </ng-container>
      </div>
    </mat-tab>
    <mat-tab label="Info">
      <div class="smart-service-task-tab">
        <div>
          <mat-form-field  color="accent" class="full-width">
            <input matInput placeholder="Task-Name" [(ngModel)]="result.name" type="text">
          </mat-form-field>
        </div>
        <div>
          <mat-form-field  color="accent" class="full-width">
            <input matInput placeholder="Module-Type" [(ngModel)]="infoModuleType" type="text">
          </mat-form-field>
        </div>
        <div>
          <mat-form-field  color="accent" class="full-width">
            <textarea matInput rows="3" placeholder="Module-Data" [(ngModel)]="infoModuleData" type="text" isValidJson></textarea>
          </mat-form-field>
        </div>
      </div>
    </mat-tab>
  </mat-tab-group>
</mat-dialog-content>

<mat-dialog-actions fxLayoutAlign="end center">
  <button mat-raised-button color="primary" (click)="close()">Cancel</button>
  <button mat-raised-button color="accent" (click)="ok()" [disabled]="isInvalid()">Ok</button>
</mat-dialog-actions>
