<!--
  ~ Copyright 2020 InfAI (CC SES)
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->


<mat-dialog-content class="edit-smart-service-task-dialog">
  <mat-tab-group  dynamicHeight="true" [(selectedIndex)]="activeIndex">
    <mat-tab label="Process">
      <div class="smart-service-task-tab">
        <div>
          <mat-form-field class="full-width">
            <input matInput placeholder="Task-Name" [(ngModel)]="result.name">
          </mat-form-field>
        </div>
        <div>
          <mat-form-field class="full-width">
            <mat-label>Process-Model</mat-label>
            <mat-select [(ngModel)]="processProcessModelId">
              <mat-option *ngFor="let model of processModels" [value]="model.id">
                {{model.name}}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>
        <div>
          <mat-form-field class="full-width" color="accent">
            <input matInput placeholder="Deployment-Name" [(ngModel)]="processProcessName" required>
          </mat-form-field>
        </div>

        <div>
          <mat-card>
            <mat-accordion>
            <mat-expansion-panel *ngFor="let taskId of processTaskIds">
              <mat-expansion-panel-header>
                <mat-panel-title>
                  {{taskId}}
                </mat-panel-title>
              </mat-expansion-panel-header>
              <div>
                <ng-container *ngFor="let input of result.inputs">
                  <div *ngIf="processTaskMatches(input, taskId, 'selection')">
                    <mat-form-field class="full-width" color="accent">
                      <mat-label>IoT-Selection</mat-label>
                      <mat-select [(ngModel)]="input.value">
                        <mat-option *ngFor="let variable of availableProcessVariables.get('iot_form_fields') || []" [value]="'${'+variable.name+'}'">
                          {{variable.label || variable.name}}
                        </mat-option>
                      </mat-select>
                    </mat-form-field>
                    <mat-form-field class="full-width" color="accent">
                      <input matInput placeholder="IoT-Selection Value" [(ngModel)]="input.value" required>
                    </mat-form-field>
                  </div>
                  <div *ngIf="processTaskMatches(input, taskId, 'time')">
                    <mat-form-field class="full-width" color="accent">
                      <input matInput placeholder="Time-Event" [(ngModel)]="input.value" required>
                    </mat-form-field>
                  </div>
                  <div *ngIf="processTaskMatches(input, taskId, 'event.flow_id')">
                    <mat-form-field class="full-width">
                      <mat-label>Event-Flow</mat-label>
                      <mat-select [(ngModel)]="input.value">
                        <mat-option *ngFor="let flow of flows" [value]="flow._id">
                          {{flow.name}}
                        </mat-option>
                      </mat-select>
                    </mat-form-field>
                  </div>
                  <div *ngIf="processTaskMatches(input, taskId, 'event.value')">
                    <mat-form-field class="full-width" color="accent">
                      <input matInput placeholder="Event-Value" [(ngModel)]="input.value">
                    </mat-form-field>
                  </div>
                  <ng-container *ngFor="let parameter of getProcessTaskParameter(taskId)">
                    <div *ngIf="processTaskMatches(input, taskId, 'parameter.'+parameter)">
                      <mat-form-field class="full-width" color="accent">
                        <input matInput placeholder="{{parameter}}" [(ngModel)]="input.value">
                      </mat-form-field>
                    </div>
                  </ng-container>
                </ng-container>
              </div>
            </mat-expansion-panel>
          </mat-accordion>
          </mat-card>
        </div>
      </div>
    </mat-tab>
    <mat-tab label="Analytics">
      <div class="smart-service-task-tab">
        <div class="smart-service-task-tab">
          <div>
            <mat-form-field class="full-width">
              <input matInput placeholder="Task-Name" [(ngModel)]="result.name">
            </mat-form-field>
          </div>
          <div>
            <mat-form-field class="full-width">
              <mat-label>Flow</mat-label>
              <mat-select [(ngModel)]="analyticsFlowId">
                <mat-option *ngFor="let flow of flows" [value]="flow._id">
                  {{flow.name}}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </div>
          <div>
            <mat-form-field class="full-width" color="accent">
              <input matInput placeholder="Pipeline-Name" [(ngModel)]="analyticsPipelineName" required>
            </mat-form-field>
          </div>
          <div>
            <mat-form-field class="full-width" color="accent">
              <input matInput placeholder="Pipeline-Description" [(ngModel)]="analyticsPipelineDesc">
            </mat-form-field>
          </div>
          <div>
            <mat-form-field class="full-width" color="accent">
              <input matInput placeholder="Pipeline Window-Time" [(ngModel)]="analyticsWindowTime" required>
            </mat-form-field>
          </div>

          <div>
            <mat-card>
              <mat-accordion>
                <mat-expansion-panel *ngFor="let flowInput of currentParsedFlows">
                  <mat-expansion-panel-header>
                    <mat-panel-title>
                      {{flowInput.name}}
                    </mat-panel-title>
                  </mat-expansion-panel-header>
                  <div>
                    <div *ngFor="let port of flowInput.inPorts">
                      <mat-divider [inset]="true"></mat-divider>
                      <h4 class="mat-h4">{{port}}</h4>
                      <ng-container *ngFor="let input of result.inputs">
                        <div *ngIf="analyticsInputMatchesIotSelection(input, flowInput.id, port)">
                          <mat-form-field class="full-width" color="accent">
                            <mat-label>IoT-Selection</mat-label>
                            <mat-select [(ngModel)]="input.value">
                              <mat-option *ngFor="let variable of availableProcessVariables.get('iot_form_fields') || []" [value]="'${'+variable.name+'}'">
                                {{variable.label || variable.name}}
                              </mat-option>
                            </mat-select>
                          </mat-form-field>
                          <mat-form-field class="full-width" color="accent">
                            <input matInput placeholder="IoT-Selection Value" [(ngModel)]="input.value" required>
                          </mat-form-field>
                        </div>
                        <div *ngIf="analyticsInputMatchesIotCriteria(input, flowInput.id, port)">
                          <mat-form-field class="full-width" color="accent">
                            <input matInput placeholder="IoT-Criteria" [(ngModel)]="input.value" required>
                          </mat-form-field>
                        </div>
                      </ng-container>
                    </div>
                    <mat-divider [inset]="true"></mat-divider>
                    <h4 class="mat-h4">Configurations</h4>
                    <div *ngFor="let config of flowInput.config">
                      <ng-container *ngFor="let input of result.inputs">
                        <div *ngIf="analyticsInputMatchesIotConfig(input, flowInput.id, config.name)">
                          <mat-form-field class="full-width" color="accent">
                            <input matInput placeholder="{{config.name}}" [(ngModel)]="input.value">
                          </mat-form-field>
                        </div>
                      </ng-container>
                    </div>
                  </div>
                </mat-expansion-panel>
              </mat-accordion>
            </mat-card>
          </div>
        </div>
      </div>
    </mat-tab>
    <mat-tab label="Export">
      <div class="smart-service-task-tab">
        <div>
          <mat-form-field class="full-width">
            <input matInput placeholder="Name" [(ngModel)]="exportRequest.Name" type="text">
          </mat-form-field>
        </div>
        <div>
          <mat-form-field class="full-width">
            <input matInput placeholder="Description" [(ngModel)]="exportRequest.Description" type="text">
          </mat-form-field>
        </div>
        <div>
          <mat-form-field class="full-width">
            <mat-label>FilterType</mat-label>
            <mat-select [(ngModel)]="exportRequest.FilterType">
              <mat-option value="deviceId">deviceId</mat-option>
              <mat-option value="pipeId">pipeId</mat-option>
              <mat-option value="operatorId">operatorId</mat-option>
              <mat-option value="import_id">import_id</mat-option>
            </mat-select>
          </mat-form-field>
        </div>
        <div>
          <mat-form-field class="full-width">
            <input matInput placeholder="Filter" [(ngModel)]="exportRequest.Filter" type="text">
          </mat-form-field>
        </div>
        <div>
          <mat-form-field class="full-width">
            <input matInput placeholder="EntityName" [(ngModel)]="exportRequest.EntityName" type="text">
          </mat-form-field>
        </div>
        <div>
          <mat-form-field class="full-width">
            <input matInput placeholder="Topic" [(ngModel)]="exportRequest.Topic" type="text">
          </mat-form-field>
        </div>
        <div>
          <mat-form-field class="full-width">
            <input matInput placeholder="Measurement" [(ngModel)]="exportRequest.Measurement" type="text">
          </mat-form-field>
        </div>
        <div>
          <mat-form-field class="full-width">
            <input matInput placeholder="DatabaseType" [(ngModel)]="exportRequest.DatabaseType" type="text">
          </mat-form-field>
        </div>
        <div>
          <mat-form-field class="full-width">
            <input matInput placeholder="Database" [(ngModel)]="exportRequest.Database" type="text">
          </mat-form-field>
        </div>
        <div>
          <mat-form-field class="full-width">
            <input matInput placeholder="DbId" [(ngModel)]="exportRequest.DbId" type="text">
          </mat-form-field>
        </div>
        <div>
          <mat-form-field class="full-width">
            <input matInput placeholder="TimePath" [(ngModel)]="exportRequest.TimePath" type="text">
          </mat-form-field>
        </div>
        <div>
          <mat-form-field class="full-width">
            <input matInput placeholder="TimePrecision" [(ngModel)]="exportRequest.TimePrecision" type="text">
          </mat-form-field>
        </div>
        <div>
          <mat-form-field class="full-width">
            <input matInput placeholder="ServiceName" [(ngModel)]="exportRequest.ServiceName" type="text">
          </mat-form-field>
        </div>
        <div>
          <mat-form-field class="full-width">
            <input matInput placeholder="ServiceName" [(ngModel)]="exportRequest.ServiceName" type="text">
          </mat-form-field>
        </div>
        <div>
          <mat-form-field class="full-width">
            <mat-label>Offset</mat-label>
            <mat-select [(ngModel)]="exportRequest.Offset">
              <mat-option value="largest">largest</mat-option>
              <mat-option value="smallest">smallest</mat-option>
            </mat-select>
          </mat-form-field>
        </div>
        <div>
          <mat-checkbox class="checkbox-margin" [(ngModel)]="exportRequest.Generated">Generated</mat-checkbox>
        </div>
        <mat-accordion>
          <mat-expansion-panel *ngFor="let value of exportRequest.Values; let i = index">
            <mat-expansion-panel-header>
              <mat-panel-title>
                {{value.Name}}
              </mat-panel-title>
            </mat-expansion-panel-header>
            <div>
              <div>
                <mat-form-field class="full-width">
                  <input matInput placeholder="Name" [(ngModel)]="value.Name" type="text">
                </mat-form-field>
              </div>
              <div>
                <mat-form-field class="full-width">
                  <input matInput placeholder="Path" [(ngModel)]="value.Path" type="text">
                </mat-form-field>
              </div>
              <div>
                <mat-form-field class="full-width">
                  <mat-label>Type</mat-label>
                  <mat-select [(ngModel)]="value.Type">
                    <mat-option value="string">string</mat-option>
                    <mat-option value="float">float</mat-option>
                  </mat-select>
                </mat-form-field>
              </div>
              <div>
                <mat-checkbox class="checkbox-margin" [(ngModel)]="value.Tag">Tag</mat-checkbox>
              </div>
              <div>
                <button mat-raised-button color="accent" (click)="removeExportValue(i)">Remove Value</button>
              </div>
            </div>
          </mat-expansion-panel>
        </mat-accordion>
        <div>
          <button mat-raised-button color="accent" (click)="addExportValue()">Add Value</button>
        </div>
      </div>
    </mat-tab>
    <mat-tab label="Import">
      <div class="smart-service-task-tab">
        <div>
          <mat-form-field class="full-width">
            <input matInput placeholder="Name" [(ngModel)]="importRequest.name" type="text">
          </mat-form-field>
        </div>
        <div>
          <mat-form-field class="full-width">
            <mat-label>Import-Type</mat-label>
            <mat-select [(ngModel)]="importTypeId">
              <mat-option *ngFor="let importType of importTypes" [value]="importType.id">
                {{importType.name}}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>
        <div>
          <mat-form-field class="full-width">
            <input matInput placeholder="Kafka Topic" [(ngModel)]="importRequest.kafka_topic" type="text">
          </mat-form-field>
        </div>
      </div>
      <div>
        <mat-checkbox class="checkbox-margin" [(ngModel)]="importRequest.restart">Generated</mat-checkbox>
      </div>
      <div>
        <mat-checkbox class="checkbox-margin" [(ngModel)]="importRequest.generated">Restart</mat-checkbox>
      </div>
      <div *ngFor="let config of importRequest.configs">
        <mat-form-field class="full-width" *ngIf="isTextImportConfig(config)">
          <input matInput placeholder="{{config.name}}" [(ngModel)]="config.value" type="text">
        </mat-form-field>
        <mat-form-field class="full-width" *ngIf="isNumberImportConfig(config)">
          <input matInput placeholder="{{config.name}}" [(ngModel)]="config.value" type="number">
        </mat-form-field>
        <mat-checkbox class="checkbox-margin" *ngIf="isBooleanImportConfig(config)" [(ngModel)]="importRequest.restart">{{config.name}}</mat-checkbox>


        <span *ngIf="isUnknownImportConfig(config)"> {{config.name}} is of unknown type: {{importRequestConfigValueType.get(config.name)}}. pleas set value via Input/Output panel. </span>
        <mat-form-field class="full-width" *ngIf="isUnknownImportConfig(config)">
          <input matInput placeholder="{{config.name}}" [(ngModel)]="config.value" type="text" isValidJson>
        </mat-form-field>
      </div>
    </mat-tab>
  </mat-tab-group>
</mat-dialog-content>

<mat-dialog-actions fxLayoutAlign="end center">
  <button mat-raised-button color="primary" (click)="close()">Cancel</button>
  <button mat-raised-button color="accent" (click)="ok()">Ok</button>
</mat-dialog-actions>

